<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ChatGPT chats with itself.</title>
    <meta name="description" content="FIXME">
    <link href="//cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        .buttonrow .input-group {
            width: auto;
        }

        .buttonrow .form-control {
            width: 5em;
        }

        .buttonrow .form-select {
            width: 7em;
        }

        .theme1 {
            --primary-color: #7E57C2;
            --secondary-color: #FF6D00;
            --tertiary-color: #90CAF9;
            --sysmsg1-color: #E8EAF6; /* pale version of tertiary-color */
            --quaternary-color: #FFAB91;
            --sysmsg2-color: #FFECE7; /* pale version of quaternary-color */
            --background-color: #F5F5F5;
            --header-color: #FFFFFF;
            --header-bg-color: #424242;
            --font-color: #212121;
            --border-color: #BDBDBD;
        }

        .theme2 {
            --primary-color: DarkSlateBlue;
            --secondary-color: DarkOrange;
            --tertiary-color: LightSkyBlue;
            --sysmsg1-color: AliceBlue; /* pale version of tertiary-color */
            --quaternary-color: LightSalmon;
            --sysmsg2-color: MistyRose; /* pale version of quaternary-color */
            --background-color: WhiteSmoke;
            --header-color: White;
            --header-bg-color: DimGray;
            --font-color: DarkSlateGray;
            --border-color: LightGray;
        }

        .theme3 {
            --primary-color: DarkCyan;
            --secondary-color: DarkGoldenRod;
            --tertiary-color: LightSteelBlue;
            --sysmsg1-color: Lavender; /* pale version of tertiary-color */
            --quaternary-color: PeachPuff;
            --sysmsg2-color: Seashell; /* pale version of quaternary-color */
            --background-color: AntiqueWhite;
            --header-color: FloralWhite;
            --header-bg-color: SlateGray;
            --font-color: DarkOliveGreen;
            --border-color: Gainsboro;
        }

        .theme4 {
            --primary-color: Teal;
            --secondary-color: Sienna;
            --tertiary-color: SkyBlue;
            --sysmsg1-color: Azure; /* pale version of tertiary-color */
            --quaternary-color: LightCoral;
            --sysmsg2-color: linen; /* pale version of quaternary-color */
            --background-color: Ivory;
            --header-color: Snow;
            --header-bg-color: DarkSlateBlue;
            --font-color: SaddleBrown;
            --border-color: Beige;
        }

        body {
            background-color: var(--background-color);
            color: var(--font-color);
        }

        .card {
            border-color: var(--border-color);
        }

        .card-header {
            background-color: var(--header-bg-color);
            color: var(--header-color);
        }

        .btn {
            background-color: var(--primary-color);
            color: var(--header-color);
            border-color: var(--primary-color);
        }

        .btn:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .sysmsg1 .card {
            background-color: var(--sysmsg1-color);
        }

        .sysmsg2 .card {
            background-color: var(--sysmsg2-color);
        }

        .chat1 .card {
            border-left: 4px solid var(--tertiary-color);
            margin-right: 10%;
        }

        .chat2 .card {
            border-left: 4px solid var(--quaternary-color);
            margin-left: 10%;
        }

        .input-group-text {
            background-color: var(--primary-color);
            color: var(--header-color);
        }

        .form-control, .theme1 .form-select {
            border-color: var(--border-color);
        }
    </style>
</head>
<body class="theme2">
<pre style="display: none" id="examplelist">
    1.name=Self-Interview
    1.sys1=Ask the user interview questions about world view, but only one question at a time.
    1.sys2=Be helpful and chatty, but not too chatty - no more than 90 words per message.
    2.name=Dirtbiking
    2.sys1=Unterhalte Dich. Halte das Gespräch in Gang, indem du mit tiefgründigen Fragen und Kommentaren antwortest, aber maximal einem pro Antwort. Und fasse Dich kurz, viel Text ist langweilig: maximal 3 Sätze. Sei ruhig frech und lustig. Rede in Jugendsprache wie ein 13-jähriger. Unterhalte Dich über Dirtbike fahren.Du bist ein Neuling und willst den Experten ausfragen.  Lange Texte sind langweilig - bitte maximal 40 Worte.
    2.sys2=Unterhalte Dich. Halte das Gespräch in Gang, indem du mit tiefgründigen Fragen und Kommentaren antwortest, aber maximal einem pro Antwort. Und fasse Dich kurz, viel Text ist langweilig: maximal 3 Sätze. Sei ruhig frech und lustig. Rede in Jugendsprache wie ein 13-jähriger. Unterhalte Dich über Dirtbike fahren.Du bist der totale Experte im Dirtbike fahren, und gibst ein bisschen an, und gibst dem Neuling Tipps. Lange Texte sind langweilig - bitte maximal 80 Worte.
</pre>
<div class="container-xxl mt-4">
    <div class="card">
        <div class="card-header">
            <h1>ChatGPT chatting with itself</h1>
        </div>
        <div class="card-body">
            <div class="row g-3 sysmsgs">
                <div class="col-lg-6 sysmsg1">
                    <div class="card">
                        <div class="card-header">
                            <label for="sysmsg1" class="form-label">System prompt for first instance:</label>
                        </div>
                        <div class="card-body">
                            <textarea id="sysmsg1" class="form-control" rows="7">Ask the user interview questions about world view, but only one question at a time.</textarea>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 sysmsg2">
                    <div class="card">
                        <div class="card-header">
                            <label for="sysmsg2" class="form-label">System prompt for second instance:</label>
                        </div>
                        <div class="card-body">
                            <textarea id="sysmsg2" class="form-control" rows="7">Be helpful and chatty, but not too chatty - no more than 90 words per message.</textarea>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <form class="form-inline">
                        <div class="d-flex flex-wrap align-items-center justify-content-start buttonrow">
                            <div class="d-flex align-items-center me-2">
                                <button type="button" class="btn me-2" id="start">Start</button>
                                <button type="button" class="btn me-2" id="continue">Continue</button>
                                <button type="button" class="btn me-2" id="stop" disabled>Stop</button>
                                <button type="button" class="btn me-2" id="help">Help</button>
                            </div>
                            <div class="input-group me-2">
                                <span class="input-group-text">Turns:</span>
                                <input type="number" class="form-control" id="turns" value="5">
                            </div>
                            <div class="input-group me-2">
                                <span class="input-group-text">Max. Tokens:</span>
                                <input type="number" class="form-control" id="tokens" value="200">
                            </div>
                            <div class="input-group me-2">
                                <label class="input-group-text" for="examples">Examples:</label>
                                <select class="form-select" id="examples">
                                    <option value="0" selected>None</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label class="input-group-text" for="themes">Theme:</label>
                                <select class="form-select" id="themes">
                                    <option value="theme1">Theme 1</option>
                                    <option value="theme2" selected>Theme 2</option>
                                    <option value="theme3">Theme 3</option>
                                    <option value="theme4">Theme 4</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="col-12">
                    <p id="helptext">Just for fun: this implements two instances of ChatGPT chatting with itself. You
                        can give two different system messages - that is messages saying ChatGPT how it should behave in
                        general, and then press start to see it jabbering away with itself, until the number of turns is
                        reached. Max Tokens limits the response size - the number of words is about 3/4 of that. If you
                        get something interesting, please please
                        <a href="http://www.stoerr.net/contact.html">send me</a> a copy!
                    </p>
                </div>

                <div id="chats" class="mt-3">
                    <div class="col-12 chat chat1">
                        <div class="card msg mb-3">
                            <div class="card-body">Hi Alice!</div>
                        </div>
                    </div>
                    <div class="col-12 chat chat2">
                        <div class="card msg mb-3">
                            <div class="card-body">Hi Bob!</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="//cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>
<script
        src="//code.jquery.com/jquery-3.6.4.min.js"
        integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8="
        crossorigin="anonymous"></script>
<script>
    // parse the #examplelist and add it to the examples select. The format is:
    // number.name=name of the example
    // number.sys1=system prompt for first instance
    // number.sys2=system prompt for second instance
    const examples = $('#examplelist').text().split('\n').map(line => line.trim());
    // first, collect the .name lines and add the number as value and the name as text for the select options of #examples
    const exampleoptions = examples.filter(line => line.indexOf('name=') > 0).map(line => {
        // number is what's before = and name what's after
        const number = line.split('=')[0].split('.')[0];
        const name = line.split('=')[1];
        return `<option value="${number}">${name}</option>`;
    });
    // add exampleoptions to #examples
    $('#examples').append(exampleoptions);

    // change handler for #examples
    $('#examples').change(function () {
        // get the number of the selected example
        const number = $('#examples').val();
        // get the lines of the example
        const examplelines = examples.filter(line => line.indexOf(number + '.') === 0);
        // get the sys1 and sys2 s
        const sys1 = examplelines.filter(line => line.indexOf('sys1=') > 0)[0].split('=')[1];
        const sys2 = examplelines.filter(line => line.indexOf('sys2=') > 0)[0].split('=')[1];
        // set the values of #sysmsg1 and #sysmsg2
        $('#sysmsg1').val(sys1);
        $('#sysmsg2').val(sys2);
    });

    $('#help').click(function () {
        $('#helptext').toggle();
    });

    $('#stop').click(function () {
        turn = parseInt($('#turns').val()) + 999999;
        $('#stop').prop('disabled', true);
        if (xhq) {
            xhq.abort();
            xhq = null;
        }
    });

    $('#start').click(function () {
        $('#chats').children().slice(2).remove();
        turn = 0;
        maxtokens = parseInt($('#tokens').val());
        setRunning(true);
        submitChat1();
    });

    $('#continue').click(function () {
        turn = 0;
        maxtokens = parseInt($('#tokens').val());
        setRunning(true);
        submitChat1();
    });

    $('#themes').change(function () {
        $('body').removeClass().addClass($('#themes').val());
    });

    function setRunning(isrunning) {
        $('#start').prop('disabled', isrunning);
        $('#continue').prop('disabled', isrunning);
        $('#stop').prop('disabled', !isrunning);
        $('#help').hide();
    }

    var turn = 0;
    var maxtokens = 0;

    function submitChat1() {
        if (turn >= $('#turns').val()) {
            setRunning(false);
            return;
        }
        var messages = [];
        var sysmsg1 = $('#sysmsg1').val();
        if (sysmsg1) {
            messages.push({"role": "system", "content": sysmsg1});
        }
        $(document).find('.chat').each(function (num, el) {
            var role = $(el).hasClass('chat1') ? 'assistant' : 'user';
            messages.push({"role": role, "content": $(el).find('.card-body').text()});
        });
        submitToGPT(messages, function (data) {
            var newchat = $('<div class="col-12 chat chat1"><div class="card msg mb-3"><div class="card-body">' + data.choices[0].message.content + '</div></div></div>');
            $('#chats').append(newchat);
            turn++;
            submitChat2();
        }, onError);
    }

    function onError(jqXHR, textStatus, errorThrown) {
        setRunning(false);
        if (textStatus !== 'abort') {
            alert("Error: " + jqXHR.status + " " + jqXHR.responseText);
        }
    }

    // submitChat2 is the same as submitChat1, but for the second instance with switched roles.
    function submitChat2() {
        if (turn >= $('#turns').val()) {
            setRunning(false);
            return;
        }
        var messages = [];
        var sysmsg2 = $('#sysmsg2').val();
        if (sysmsg2) {
            messages.push({"role": "system", "content": sysmsg2});
        }
        $(document).find('.chat').each(function (num, el) {
            var role = $(el).hasClass('chat2') ? 'assistant' : 'user';
            messages.push({"role": role, "content": $(el).find('.card-body').text()});
        });
        submitToGPT(messages, function (data) {
            var newchat = $('<div class="col-12 chat chat2"><div class="card msg mb-3"><div class="card-body">' + data.choices[0].message.content + '</div></div></div>');
            $('#chats').append(newchat);
            turn++;
            submitChat1();
        }, onError);
    }

    var xhq;

    /** Submits a message array via $.ajax to https://api.openai.com/v1/chat/completions .
     * @param messages array of messages [{"role": role, "content": thecontent}, ...] where role is 'user' or 'agent' or 'system'
     * @param resultcallback gets the data from the result
     * @param errorcallback in case of errors. */
    function submitToGPT(messages, resultcallback, errorcallback) {
        // fetch api key from local storage, or else prompt if not found
        var api_key = localStorage.getItem('api_key');
        if (!api_key) {
            api_key = prompt("Please enter your API key, which you can create in your profile at https://platform.openai.com/");
            if (api_key) {
                localStorage.setItem('api_key', api_key);
            }
        }

        var retries = 0;

        function maybeRetryOnError(jqXHR, textStatus, errorThrown) {
            if (jqXHR.status === 429 && retries < 3) {
                retries++;
                // find something like ' Please try again in 20s. ' in the response text , parse the number and retry after that many seconds.
                var seconds = 21; // default if we don't find something.
                var match = jqXHR.responseText.match(/Please try again in (\d+)s\./);
                if (match) {
                    seconds = parseInt(match[1]);
                }
                console.log("Got 429, retrying in " + seconds + " seconds.");
                setTimeout(performCall, seconds * 1000);
            } else {
                errorcallback(jqXHR, textStatus, errorThrown);
            }
        }

        function performCall() {
            xhq = $.ajax({
                url: 'https://api.openai.com/v1/chat/completions',
                type: 'POST',
                dataType: 'json',
                headers: {
                    'Authorization': 'Bearer ' + api_key,
                    'Content-Type': 'application/json',
                },
                data: JSON.stringify({
                    model: "gpt-3.5-turbo",
                    max_tokens: maxtokens,
                    messages: messages,
                }),
                success: resultcallback,
                error: maybeRetryOnError
            });
        }

        performCall();
    }

</script>
</body>
</html>
